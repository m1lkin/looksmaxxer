# Часть 5: Продвинутое использование

Раздел для тех, кто хочет знать больше: детали работы с файлами, обработка ошибок и нюансы API.

## Содержание
1. [Глубокое погружение в Upload (Загрузка файлов)](#глубокое-погружение-в-upload)
2. [Работа с видео (Video Info)](#работа-с-видео)
3. [Обработка ошибок (Exceptions)](#обработка-ошибок)
4. [Прямой доступ к API](#прямой-доступ-к-api)

---

## Глубокое погружение в Upload

Загрузка файлов в API MAX происходит в два этапа:
1.  **Получение URL**: Клиент запрашивает у сервера ссылку, куда можно загрузить файл.
2.  **Загрузка**: Клиент отправляет бинарные данные на полученный URL.

В библиотеке `looksmaxxer` метод `$client->uploadFile()` делает это автоматически.

```php
use Looksmaxxer\Enums\UploadType;

// Метод возвращает готовый объект Attachment
$attachment = $client->uploadFile('/path/to/file.pdf', UploadType::FILE);

// Внутри $attachment уже лежит нужный токен.
// Его можно сохранить в базу данных, чтобы не загружать файл каждый раз! 
$token = $attachment->payload->toArray()['token']; 

// Повторное использование (без загрузки)
$messageBuilder->file($token);
```

**Типы загрузки (UploadType):**
*   `IMAGE`: Для картинок. Возвращает токен после шага 2.
*   `FILE`, `VIDEO`, `AUDIO`: Токен выдается сразу на шаге 1.

---

## Работа с видео

Если вы получили видео-сообщение, вы можете узнать подробности о видео (длительность, разрешение) и получить прямые ссылки на потоки (MP4, HLS).

```php
// $update - это входящее сообщение с видео
$videoPayload = $update->message->getAttachments()[0]->payload; // Или метод-хелпер, если есть
$token = $videoPayload->token;

// Запрашиваем инфо
$info = $client->getVideoInfo($token);

echo "Ширина: {$info->width}, Высота: {$info->height}\n";
echo "Длительность: {$info->duration} сек.\n";

if ($info->urls->mp4_1080) {
    echo "Ссылка на 1080p: " . $info->urls->mp4_1080;
}
```

---

## Обработка ошибок

Библиотека использует исключения для сообщения об ошибках.

*   **`Looksmaxxer\Exceptions\MaxException`**: Базовое исключение для всех ошибок библиотеки.

Ошибки могут возникать на уровне сети (GuzzleException) или на уровне API (неверный токен, нет прав, лимит запросов). Библиотека оборачивает их в `MaxException`.

Пример правильной обработки:

```php
use Looksmaxxer\Exceptions\MaxException;

try {
    $client->sendMessage($msg);
} catch (MaxException $e) {
    // Получить HTTP код (например, 403 Forbidden)
    $code = $e->getCode(); 
    
    // Получить описание ошибки
    $error = $e->getMessage();
    
    if ($code == 429) {
        // Слишком много запросов, нужно подождать
        sleep(5);
    } elseif ($code == 403) {
        // Бот заблокирован пользователем или кикнут из чата
        // Стоит пометить пользователя в БД как "inactive"
    } else {
        // Логируем неизвестную ошибку
        error_log("API Error ($code): $error");
    }
}
```

---

## Прямой доступ к API

Если вам кажется, что в библиотеке не хватает какого-то метода, или вы хотите получить "сырой" ответ от сервера, вы можете расширить класс `Client` (так как базовый метод `request` приватный, придется использовать наследование или рефлексию, но мы рекомендуем использовать публичные методы).

Все модели (`Chat`, `User` и т.д.) имеют статический метод `fromArray($data)`. Если вы получили данные из другого источника (например, сохранили JSON вебхука в БД и хотите восстановить объект), используйте его:

```php
use Looksmaxxer\Models\Message;

$json = '{"timestamp": 123, "body": {...}}'; // Данные из БД
$data = json_decode($json, true);

$message = Message::fromArray($data);
echo $message->getText();
```