# Часть 1: Начало работы и Установка

Добро пожаловать в документацию библиотеки `looksmaxxer`. Это руководство проведет вас через все этапы создания бота для платформы MAX: от установки библиотеки до запуска вашего первого бота в продакшн.

## Содержание
1. [Требования](#требования)
2. [Установка](#установка)
3. [Получение токена](#получение-токена)
4. [Архитектура: Client vs Bot](#архитектура-client-vs-bot)
5. [Режим Long Polling (Разработка)](#режим-long-polling-разработка)
6. [Режим Webhook (Продакшн)](#режим-webhook-продакшн)

---

## Требования

Перед началом убедитесь, что ваше окружение соответствует минимальным требованиям:
*   **PHP 8.2** или выше.
*   **Composer** (пакетный менеджер PHP).
*   Расширение **ext-json** (для работы с данными API).
*   Расширение **ext-curl** (используется Guzzle для HTTP-запросов).

---

## Установка

Откройте терминал в папке вашего проекта и выполните команду:

```bash
composer require m1lkin/looksmaxxer
```

Эта команда скачает библиотеку и все её зависимости (Guzzle, PHPUnit и др.) в папку `vendor`.

Не забудьте подключить автозагрузчик Composer в начале вашего скрипта:

```php
require __DIR__ . '/vendor/autoload.php';
```

---

## Получение токена

Чтобы управлять ботом, вам нужен специальный ключ доступа — **Токен**.

1.  Откройте платформу MAX.
2.  Перейдите в раздел **"Чат-бот и мини-приложение"**.
3.  Нажмите **"Настроить"**.
4.  Скопируйте строку токена. Она выглядит примерно так: `123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11`.

> **Важно:** Никогда не публикуйте токен в публичных репозиториях (GitHub и др.). Храните его в переменных окружения или конфигах, которые добавлены в `.gitignore`.

---

## Архитектура: Client vs Bot

Библиотека предоставляет два уровня взаимодействия:

1.  **`Looksmaxxer\Client` (Низкий уровень)**
    *   Это прямая обертка над HTTP API.
    *   У него есть методы `sendMessage`, `getChat`, `uploadFile` и т.д.
    *   Он **не умеет** сам слушать обновления (входящие сообщения). Он только отправляет запросы.
    *   Используйте его, если вам нужно просто отправить сообщение из скрипта, который не является ботом.

2.  **`Looksmaxxer\Bot` (Высокий уровень)**
    *   Это "мозг" вашего бота.
    *   Он содержит внутри себя экземпляр `Client`.
    *   Он умеет **получать обновления** (через Long Polling или Webhook).
    *   Он предоставляет систему событий (`onMessage`, `onCommand`...). 
    *   **Рекомендуется использовать именно его.**

---

## Режим Long Polling (Разработка)

**Long Polling (Длинные опросы)** — это метод, когда ваш скрипт постоянно спрашивает сервер: "Есть новые сообщения?". Если сообщений нет, сервер "держит" соединение открытым до 30 секунд, а потом отвечает "ничего нет". Скрипт тут же спрашивает снова.

**Плюсы:**
*   Не нужен публичный IP или домен.
*   Не нужен SSL сертификат.
*   Работает прямо с вашего локального компьютера.
*   Идеально для разработки и отладки.

**Минусы:**
*   Менее эффективно тратит ресурсы.
*   Может работать с задержкой при высокой нагрузке.

**Пример бота (Long Polling):**

Создайте файл `bot_polling.php`:

```php
<?php

require __DIR__ . '/vendor/autoload.php';

use Looksmaxxer\Bot;
use Looksmaxxer\Models\Update;
use Looksmaxxer\Client;
use Looksmaxxer\Builders\MessageBuilder;

// 1. Создаем экземпляр Бота
$bot = new Bot('ВАШ_ТОКЕН_ЗДЕСЬ');

// 2. Добавляем простую реакцию на команду /start
$bot->onCommand('start', function (Update $update, Client $client) {
    $chatId = $update->chatId;
    
    // Отправляем ответ
    $client->sendMessage(
        MessageBuilder::create($chatId)->text("Привет! Я работаю локально.")
    );
    
    echo "Команда /start обработана!\n";
});

// 3. Запускаем бесконечный цикл
echo "Бот запущен в режиме Long Polling...\n";
$bot->start();
```

Запустите в консоли:
```bash
php bot_polling.php
```

---

## Режим Webhook (Продакшн)

**Webhook** — это механизм, когда сервер MAX сам присылает данные вашему скрипту. Сервер MAX отправляет HTTP POST запрос на ваш URL каждый раз, когда происходит событие.

**Плюсы:**
*   Моментальная реакция.
*   Экономия ресурсов (скрипт запускается только когда есть работа).
*   Требование платформы для высоконагруженных ботов.

**Минусы:**
*   Нужен публичный домен (https://mysite.com).
*   Нужен SSL сертификат (https обязателен).

### Шаг 1: Установка вебхука (Один раз)

Вы должны сказать серверу MAX, на какой URL слать данные. Создайте скрипт `setup.php`:

```php
<?php
require __DIR__ . '/vendor/autoload.php';

use Looksmaxxer\Client;
use Looksmaxxer\Builders\SubscriptionBuilder;
use Looksmaxxer\Enums\UpdateType;

$client = new Client('ВАШ_ТОКЕН');

// Формируем запрос на подписку
$builder = SubscriptionBuilder::create('https://ваш-домен.ru/webhook.php')
    ->updateTypes([
        UpdateType::MESSAGE_CREATED, 
        UpdateType::MESSAGE_CALLBACK,
        UpdateType::USER_ADDED
    ])
    ->secret('super_secure_secret_key'); // Секрет для защиты (опционально)

// Отправляем запрос
$response = $client->subscribe($builder);

if ($response->success) {
    echo "Вебхук успешно установлен!";
} else {
    echo "Ошибка: " . $response->message;
}
```

Запустите его один раз: `php setup.php`.

### Шаг 2: Обработчик (webhook.php)

Этот файл должен быть доступен из интернета по адресу, который вы указали выше (`https://ваш-домен.ru/webhook.php`).

```php
<?php
require __DIR__ . '/vendor/autoload.php';

use Looksmaxxer\Bot;
use Looksmaxxer\Models\Update;
use Looksmaxxer\Client;
use Looksmaxxer\Builders\MessageBuilder;

// Инициализируем бота
$bot = new Bot('ВАШ_ТОКЕН');

// Регистрируем логику (она такая же, как и в Long Polling!)
$bot->onMessage(function (Update $update, Client $client) {
    $client->sendMessage(
        MessageBuilder::create($update->chatId)->text("Ответ через Webhook!")
    );
});

// ВАЖНО: Вместо start() вызываем handleWebhook()
// Этот метод прочитает входящий запрос, обработает его и завершит работу.
$bot->handleWebhook();
```

Теперь ваш бот готов к работе в реальном мире!